#!/bin/bash

if [ x$1 == x"precustomization" ]; then
  exit 0
fi

exec &>> /var/log/customization.log
echo "Customization started `date`"

#put your customization settings here
vidaas_admin_repo_path=/root/
vidaas_node_type=project

#existing settings file overrides defaults
if [ -f /etc/vidaas/settings ] ; then
  source /etc/vidaas/settings
fi
if [ ! -d /etc/vidaas ] ; then
  mkdir /etc/vidaas
fi
echo "Updating settings file..."
(
cat <<EndOfFile
vidaas_admin_repo_path=$vidaas_admin_repo_path
vidaas_node_type=$vidaas_node_type
EndOfFile
) > /etc/vidaas/settings

echo "Checking out admin repository into $vidaas_config_repo_path"
if [ ! -f /usr/bin/svn ] ; then
  if ! apt-get -qqy install subversion ; then
    echo "Unable to install subversion package"
    exit 1
  fi
fi
cd $vidaas_config_repo_path
if ! svn checkout https://vidaas.googlecode.com/svn/admin ; then
  echo "svn checkout failed"
  exit 1
fi

# run whatever is required next
sh $vidaas_config_repo_path/admin/scripts/vidaas-image-minimal
